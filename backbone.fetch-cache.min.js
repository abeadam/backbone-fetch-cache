/*  backbone-fetch-cache v1.5.5 (2015-03-03)
  by MadGlory <hello@madglory.com> (http://madglory.com) - https://github.com/madglory/backbone-fetch-cache.git
 */
!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone","jquery"],function(_,Backbone,c){return a.Backbone=b(_,Backbone,c)}):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=b(require("underscore"),require("backbone"),require("jquery")):a.Backbone=b(a._,a.Backbone,a.jQuery)}(this,function(_,Backbone,a){function b(b,c){if(b&&_.isObject(b)){if(_.isFunction(b.getCacheKey))return b.getCacheKey(c);b=c&&c.url?c.url:_.isFunction(b.url)?b.url():b.url}else if(_.isFunction(b))return b(c);return c&&c.data?"string"==typeof c.data?b+"?"+c.data:b+"?"+a.param(c.data):b}function c(a,b,c){b=b||{};var e,f=Backbone.fetchCache.getCacheKey(a,b),g=!1,h=null,i=b.lastSync||(new Date).getTime(),j=!1,k=null;f&&b.cache!==!1&&(b.cache||b.prefill)&&(b.expires!==!1&&(g=(new Date).getTime()+1e3*(b.expires||300),h=function(){setTimeout(function(){a.trigger("cacheexpired",a,c,b)},1e3*(b.expires||300))}()),b.prefillExpires!==!1&&(j=(new Date).getTime()+1e3*(b.prefillExpires||300),k=function(){setTimeout(function(){a.trigger("cacheprefillexpired",a,c,b)},1e3*(b.prefillExpires||300))}()),e={expires:g,onExpire:h,lastSync:i,prefillExpires:j,onPrefillExpire:k,value:c},Backbone.fetchCache._cache[f]=e,Backbone.fetchCache._localStorageContent[f]=e,Backbone.fetchCache.setLocalStorage(Backbone.fetchCache._localStorageContent),Backbone.fetchCache.prefetch&&d(a,b))}function d(a,b){var c={type:a instanceof Backbone.Model?"Model":"Collection",saveTime:(new Date).getTime(),opts:_.extend({},a.url&&!b.url?{url:_.isFunction(a.url)?a.url():a.url}:{},b)},d=Backbone.fetchCache.getCacheKey(a,b);delete c.opts.beforeSend,delete c.opts.success,delete c.opts.fail,delete c.opts.error,Backbone.fetchCache._prerequests[d]=Backbone.fetchCache.prefetchStoreProcessor(c),Backbone.fetchCache.setPrefetchRequests()}function e(a,c){return _.isFunction(a)?a=a():a&&_.isObject(a)&&(a=b(a,c)),Backbone.fetchCache._cache[a]}function f(a){return e(a)&&e(a).lastSync}function g(a,c){_.isFunction(a)?a=a():a&&_.isObject(a)&&(a=b(a,c)),delete Backbone.fetchCache._cache[a],Backbone.fetchCache._localStorageContent[a]&&(delete Backbone.fetchCache._localStorageContent[a],Backbone.fetchCache.setLocalStorage(Backbone.fetchCache._localStorageContent))}function h(a){if(r&&Backbone.fetchCache.localStorage){_.isEmpty(a)&&(_.isEmpty(Backbone.fetchCache._localStorageContent)?_.isEmpty(Backbone.fetchCache._cache)||(a=Backbone.fetchCache._cache):a=Backbone.fetchCache._localStorageContent);try{a&&localStorage.setItem(Backbone.fetchCache.getLocalStorageKey(),JSON.stringify(a))}catch(b){var c=b.code||b.number||b.message;if(22!==c&&1014!==c)throw b;this._deleteCacheWithPriority(Backbone.fetchCache._cache)}}}function i(){function b(a){var b=a.target.result;e.resolve(b)}var c,d,e=a.Deferred();s&&Backbone.fetchCache.useIndexDB||e.reject("not supported");try{c=window.indexedDB.open("fetchCache",1),c.onsuccess=function(a){d=b(a)},c.onfailure=function(){e.reject("failed with error code: "+c.errorCode)},c.onupgradeneeded=function(a){var b,c=a.target.result;b=c.createObjectStore("fetchCacheHistory"),b.transaction.oncomplete=function(){e.resolve(c)}}}catch(f){e.reject(f.message)}return e}function j(a,b){var c=i(),d=function(b){var c,d=b.transaction(["fetchCacheHistory"],"readwrite"),e=d.objectStore("fetchCacheHistory");d.oncomplete=a,c=e.clear(),c.onsuccess=function(){try{e.add({history:_.clone(Backbone.fetchCache._prerequests)},Backbone.fetchCache.getPrefetchStorageKey())}catch(a){}}};c.done(function(a){a.onerror=function(a){b("failed with error code: "+a.target.errorCode)},d(a)}),c.fail(function(a){b(a)})}function k(a,b){var c=i(),d=function(b){var c=b.transaction(["fetchCacheHistory"],"readwrite"),d=c.objectStore("fetchCacheHistory"),e={};d.openCursor().onsuccess=function(b){var c=b.target.result;c?(e=c.value.history,c["continue"]()):a(e)}};c.done(function(a){a.onerror=function(a){c.reject("failed with error code: "+a.target.errorCode)},d(a)}),c.fail(function(a){b(a)})}function l(){var a=function(){if(Backbone.fetchCache.localStorage){s=!1;try{localStorage.setItem(Backbone.fetchCache.getPrefetchStorageKey(),JSON.stringify(Backbone.fetchCache._prerequests)),_.defer(function(){Backbone.trigger("prefetchSaved")})}catch(a){var b=a.code||a.number||a.message;if(22!==b&&1014!==b)throw a;this._deleteCacheWithPriority(),Backbone.fetchCache.setPrefetchRequests()}}};r&&Backbone.fetchCache.prefetch&&(s&&Backbone.fetchCache.useIndexDB?Backbone.fetchCache.indexSaveBlocked||j(function(){Backbone.fetchCache.indexSaveBlocked=!1,Backbone.trigger("prefetchSaved")},a):a())}function m(){var a={};if(r&&Backbone.fetchCache.localStorage){var b=localStorage.getItem(Backbone.fetchCache.getLocalStorageKey())||"{}";try{a=JSON.parse(b)}catch(c){a={}}Backbone.fetchCache._cache=_.clone(a),Backbone.fetchCache._localStorageContent=_.clone(a)}}function n(a){_.each(a,function(a,b){var c=Backbone.fetchCache.prefetchRetrieveProcessor(a);Backbone.fetchCache._prerequests[b]=c,t(function(){var d=e(b);(!d||!d.data||d.data.expires>(new Date).getTime())&&(new Backbone[c.type]).fetch(a.opts)})}),a&&a.length||Backbone.trigger("prefetchLoaded"),Backbone.fetchCache._prerequests={}}function o(){var a,b=function(){Backbone.fetchCache.localStorage&&(a=localStorage.getItem(Backbone.fetchCache.getPrefetchStorageKey()),n(JSON.parse(a)))};r&&Backbone.fetchCache.prefetch&&(s&&Backbone.fetchCache.useIndexDB?k(function(a){Backbone.fetchCache.prefetch&&n(a)},b):b())}function p(a){return window.setTimeout(a,0)}var q={modelFetch:Backbone.Model.prototype.fetch,modelSync:Backbone.Model.prototype.sync,collectionFetch:Backbone.Collection.prototype.fetch},r=function(){var a="undefined"!=typeof window.localStorage;if(a)try{localStorage.setItem("test_support","test_support"),localStorage.removeItem("test_support")}catch(b){a=!1}return a}(),s=!!window.indexedDB;Backbone.fetchCache=Backbone.fetchCache||{},Backbone.fetchCache._cache=Backbone.fetchCache._cache||{},Backbone.fetchCache.enabled=!0,Backbone.fetchCache.selfParameter=!0,Backbone.fetchCache.prefetch=!1,Backbone.fetchCache.useIndexDB=!1,Backbone.fetchCache._prerequests={},Backbone.fetchCache._localStorageContent={},Backbone.fetchCache.enablePrefetch=function(){Backbone.fetchCache.prefetch=!0,Backbone.fetchCache.getPrefetchRequests()},Backbone.fetchCache.disablePrefetch=function(){Backbone.fetchCache.prefetch=!1},Backbone.fetchCache.priorityFn=function(a,b){return a&&a.expires&&b&&b.expires?a.expires-b.expires:a},Backbone.fetchCache._prioritize=function(a){a=a||Backbone.fetchCache._cache;var b=_.values(a).sort(this.priorityFn),c=_.indexOf(_.values(a),b[0]);return _.keys(a)[c]},Backbone.fetchCache.prefetchStoreProcessor=function(a){return a},Backbone.fetchCache.prefetchRetrieveProcessor=function(a){return a},Backbone.fetchCache._deleteCacheWithPriority=function(a){a=a||Backbone.fetchCache._cache;var b=this._prioritize(a);a[b]=null,delete a[b],Backbone.fetchCache.setLocalStorage(a)},Backbone.fetchCache.getLocalStorageKey=function(){return"backboneCache"},Backbone.fetchCache.getPrefetchStorageKey=function(){return"backboneCachePrefetch"},"undefined"==typeof Backbone.fetchCache.localStorage&&(Backbone.fetchCache.localStorage=!0);var t=function(){function b(){c.length>0?a.active<2?(c.splice(0,1)[0](),b()):setTimeout(b,2e3):Backbone.trigger("prefetchLoaded")}var c=[];return function(a){c.push(a),b()}}();return Backbone.Model.prototype.fetch=function(b){function c(){return b.prefill&&(!b.prefillExpires||i)}function d(){var a=(Backbone.fetchCache.selfParameter?[]:[g.value]).concat(l);b.parse&&(j=l.parse(j,b)),l.set(j,b),_.isFunction(b.prefillSuccess)&&b.prefillSuccess(l,j,b),l.trigger("cachesync",l,j,b),l.trigger("sync",l,j,b),c()?k.notify.apply(l,a):(_.isFunction(b.success)&&b.success(l,j,b),k.resolve.apply(l,a))}if(!Backbone.fetchCache.enabled)return q.modelFetch.apply(this,arguments);b=_.defaults(b||{},{parse:!0});var f=Backbone.fetchCache.getCacheKey(this,b),g=e(f),h=!1,i=!1,j=!1,k=new a.Deferred,l=this;if(k.success=k.done,k.error=k.fail,g&&(h=g.expires,h=h&&g.expires<=(new Date).getTime(),i=g.prefillExpires,i=i&&g.prefillExpires<=(new Date).getTime(),j=g.value),!h&&(b.cache||b.prefill)&&j&&(null==b.async&&(b.async=!0),b.beforeSend&&b.beforeSend.apply(this,[k,b]),b.async?p(d):d(),!c()))return k;var m=q.modelFetch.apply(this,arguments),n=[];return Backbone.fetchCache.selfParameter&&n.push(this),m.done(function(a){k.resolve.apply(l,n.concat([a,l]))}).done(_.bind(Backbone.fetchCache.setCache,null,this,b)).fail(_.bind.apply(_,[k.reject].concat(n))),k.abort=m.abort,k},Backbone.Model.prototype.sync=function(a,b,c){if("read"===a||!Backbone.fetchCache.enabled)return q.modelSync.apply(this,arguments);var d,e,f=b.collection,h=[];for(h.push(Backbone.fetchCache.getCacheKey(b,c)),f&&h.push(Backbone.fetchCache.getCacheKey(f)),d=0,e=h.length;e>d;d++)g(h[d]);return q.modelSync.apply(this,arguments)},Backbone.Collection.prototype.fetch=function(b){function c(){return b.prefill&&(!b.prefillExpires||h)}function d(){var a=(Backbone.fetchCache.selfParameter?[]:[l.value]).concat(f);f[b.reset?"reset":"set"](i,b),_.isFunction(b.prefillSuccess)&&b.prefillSuccess(f),f.trigger("cachesync",f,i,b),f.trigger("sync",f,i,b),c()?j.notify.apply(f,a):(_.isFunction(b.success)&&b.success(f,i,b),j.resolve.apply(f,a))}if(!Backbone.fetchCache.enabled)return q.collectionFetch.apply(this,arguments);b=_.defaults(b||{},{parse:!0});var f=this,g=!1,h=!1,i=!1,j=new a.Deferred,k=Backbone.fetchCache.getCacheKey(f,b),l=e(k);if(j.success=j.done,j.error=j.fail,l&&(g=l.expires,g=g&&l.expires<=(new Date).getTime(),h=l.prefillExpires,h=h&&l.prefillExpires<=(new Date).getTime(),i=l.value),!g&&(b.cache||b.prefill)&&i&&(null==b.async&&(b.async=!0),b.beforeSend&&b.beforeSend.apply(this,[j,b]),b.async?p(d):d(),!c()))return j;var m=q.collectionFetch.apply(this,arguments),n=[];return Backbone.fetchCache.selfParameter&&n.push(this),m.done(function(a){j.resolve.apply(f,n.concat([a,f]))}).done(_.bind(Backbone.fetchCache.setCache,null,this,b)).fail(_.bind.apply(_,[j.reject].concat(n))),j.abort=m.abort,j},m(),o(),Backbone.fetchCache._superMethods=q,Backbone.fetchCache.setCache=c,Backbone.fetchCache.getCache=e,Backbone.fetchCache.getCacheKey=b,Backbone.fetchCache.getLastSync=f,Backbone.fetchCache.clearItem=g,Backbone.fetchCache.setLocalStorage=h,Backbone.fetchCache.getLocalStorage=m,Backbone.fetchCache.setPrefetchRequests=l,Backbone.fetchCache.getPrefetchRequests=o,Backbone});