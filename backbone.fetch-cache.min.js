/*  backbone-fetch-cache v1.5.5 (2015-03-05)
  by MadGlory <hello@madglory.com> (http://madglory.com) - https://github.com/madglory/backbone-fetch-cache.git
 */
!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone","jquery"],function(_,Backbone,c){return a.Backbone=b(_,Backbone,c)}):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=b(require("underscore"),require("backbone"),require("jquery")):a.Backbone=b(a._,a.Backbone,a.jQuery)}(this,function(_,Backbone,a){function b(b,c){if(b&&_.isObject(b)){if(_.isFunction(b.getCacheKey))return b.getCacheKey(c);b=c&&c.url?c.url:_.isFunction(b.url)?b.url():b.url}else if(_.isFunction(b))return b(c);return c&&c.data?"string"==typeof c.data?b+"?"+c.data:b+"?"+a.param(c.data):b}function c(a,b,c){var d={expires:!1,onExpire:null,lastSync:b.lastSync||(new Date).getTime(),prefillExpires:!1,onPrefillExpire:null};return b.expires!==!1&&(d.expires=(new Date).getTime()+1e3*(b.expires||300),d.onExpire=function(){setTimeout(function(){a.trigger("cacheexpired",a,c,b)},1e3*(b.expires||300))}()),b.prefillExpires!==!1&&(d.prefillExpires=(new Date).getTime()+1e3*(b.prefillExpires||300),d.onPrefillExpire=function(){setTimeout(function(){a.trigger("cacheprefillexpired",a,c,b)},1e3*(b.prefillExpires||300))}()),d}function d(a,b,d,f,g){if(b=b||{},d||!g||304!==g.status){var h,i,j=Backbone.fetchCache.getCacheKey(a,b);j&&b.cache!==!1&&(b.cache||b.prefill)&&(i={value:d},_.extend(i,c(a,b,d)),Backbone.fetchCache.useEtags&&(h=g&&g.getResponseHeader("etag"),h&&(i.etag=h)),Backbone.fetchCache._cache[j]=i,Backbone.fetchCache._localStorageContent[j]=i,Backbone.fetchCache.setLocalStorage(Backbone.fetchCache._localStorageContent),Backbone.fetchCache.prefetch&&e(a,b))}}function e(a,b){var c={type:a instanceof Backbone.Model?"Model":"Collection",saveTime:(new Date).getTime(),opts:_.extend({},a.url&&!b.url?{url:_.isFunction(a.url)?a.url():a.url}:{},b)},d=Backbone.fetchCache.getCacheKey(a,b);delete c.opts.beforeSend,delete c.opts.success,delete c.opts.fail,delete c.opts.error,Backbone.fetchCache._prerequests[d]=Backbone.fetchCache.prefetchStoreProcessor(c),Backbone.fetchCache.setPrefetchRequests()}function f(a,c){return _.isFunction(a)?a=a():a&&_.isObject(a)&&(a=b(a,c)),Backbone.fetchCache._cache[a]}function g(a){return f(a)&&f(a).lastSync}function h(a,c){_.isFunction(a)?a=a():a&&_.isObject(a)&&(a=b(a,c)),delete Backbone.fetchCache._cache[a],Backbone.fetchCache._localStorageContent[a]&&(delete Backbone.fetchCache._localStorageContent[a],Backbone.fetchCache.setLocalStorage(Backbone.fetchCache._localStorageContent))}function i(a){if(t&&Backbone.fetchCache.localStorage){_.isEmpty(a)&&(_.isEmpty(Backbone.fetchCache._localStorageContent)?_.isEmpty(Backbone.fetchCache._cache)||(a=Backbone.fetchCache._cache):a=Backbone.fetchCache._localStorageContent);try{a&&localStorage.setItem(Backbone.fetchCache.getLocalStorageKey(),JSON.stringify(a))}catch(b){var c=b.code||b.number||b.message;if(22!==c&&1014!==c)throw b;this._deleteCacheWithPriority(Backbone.fetchCache._cache)}}}function j(){function b(a){var b=a.target.result;e.resolve(b)}var c,d,e=a.Deferred();u&&Backbone.fetchCache.useIndexDB||e.reject("not supported");try{c=window.indexedDB.open("fetchCache",1),c.onsuccess=function(a){d=b(a)},c.onfailure=function(){e.reject("failed with error code: "+c.errorCode)},c.onupgradeneeded=function(a){var b,c=a.target.result;b=c.createObjectStore("fetchCacheHistory"),b.transaction.oncomplete=function(){e.resolve(c)}}}catch(f){e.reject(f.message)}return e}function k(a,b){var c=j(),d=function(b){var c,d=b.transaction(["fetchCacheHistory"],"readwrite"),e=d.objectStore("fetchCacheHistory");d.oncomplete=a,c=e.clear(),c.onsuccess=function(){try{e.add({history:_.clone(Backbone.fetchCache._prerequests)},Backbone.fetchCache.getPrefetchStorageKey())}catch(a){}}};c.done(function(a){a.onerror=function(a){b("failed with error code: "+a.target.errorCode)},d(a)}),c.fail(function(a){b(a)})}function l(a,b){var c=j(),d=function(b){var c=b.transaction(["fetchCacheHistory"],"readwrite"),d=c.objectStore("fetchCacheHistory"),e={};d.openCursor().onsuccess=function(b){var c=b.target.result;c?(e=c.value.history,c["continue"]()):a(e)}};c.done(function(a){a.onerror=function(a){c.reject("failed with error code: "+a.target.errorCode)},d(a)}),c.fail(function(a){b(a)})}function m(){var a=function(){if(Backbone.fetchCache.localStorage){u=!1;try{localStorage.setItem(Backbone.fetchCache.getPrefetchStorageKey(),JSON.stringify(Backbone.fetchCache._prerequests)),_.defer(function(){Backbone.trigger("prefetchSaved")})}catch(a){var b=a.code||a.number||a.message;if(22!==b&&1014!==b)throw a;this._deleteCacheWithPriority(),Backbone.fetchCache.setPrefetchRequests()}}};t&&Backbone.fetchCache.prefetch&&(u&&Backbone.fetchCache.useIndexDB?Backbone.fetchCache.indexSaveBlocked||k(function(){Backbone.fetchCache.indexSaveBlocked=!1,Backbone.trigger("prefetchSaved")},a):a())}function n(){var a={};if(t&&Backbone.fetchCache.localStorage){var b=localStorage.getItem(Backbone.fetchCache.getLocalStorageKey())||"{}";try{a=JSON.parse(b)}catch(c){a={}}Backbone.fetchCache._cache=_.clone(a),Backbone.fetchCache._localStorageContent=_.clone(a)}}function o(a){_.each(a,function(a,b){var c=Backbone.fetchCache.prefetchRetrieveProcessor(a);Backbone.fetchCache._prerequests[b]=c,v(function(){var d=f(b);(!d||!d.data||d.data.expires>(new Date).getTime())&&(new Backbone[c.type]).fetch(a.opts)})}),a&&a.length||Backbone.trigger("prefetchLoaded"),Backbone.fetchCache._prerequests={}}function p(){var a,b=function(){Backbone.fetchCache.localStorage&&(a=localStorage.getItem(Backbone.fetchCache.getPrefetchStorageKey()),o(JSON.parse(a)))};t&&Backbone.fetchCache.prefetch&&(u&&Backbone.fetchCache.useIndexDB?l(function(a){Backbone.fetchCache.prefetch&&o(a)},b):b())}function q(a){return window.setTimeout(a,0)}function r(b,c){var d,e=c[2]||{},f=Backbone.fetchCache.getCacheKey(b,e);return Backbone.fetchCache.enabled&&e.cache&&Backbone.fetchCache.useEtags&&(d=e.success,e.success=function(c,g,h){var i;304===h.status?(i=Backbone.fetchCache.getCache(f),i?b.trigger("resetData",i,e):delete a.etag[f]):d.apply(b,arguments)}),c}var s={modelFetch:Backbone.Model.prototype.fetch,modelSync:Backbone.Model.prototype.sync,collectionSync:Backbone.Collection.prototype.sync,collectionFetch:Backbone.Collection.prototype.fetch},t=function(){var a="undefined"!=typeof window.localStorage;if(a)try{localStorage.setItem("test_support","test_support"),localStorage.removeItem("test_support")}catch(b){a=!1}return a}(),u=!!window.indexedDB;Backbone.fetchCache=Backbone.fetchCache||{},Backbone.fetchCache._cache=Backbone.fetchCache._cache||{},Backbone.fetchCache.enabled=!0,Backbone.fetchCache.selfParameter=!0,Backbone.fetchCache.prefetch=!1,Backbone.fetchCache.useIndexDB=!1,Backbone.fetchCache._prerequests={},Backbone.fetchCache._localStorageContent={},Backbone.fetchCache.useEtags=!0,Backbone.fetchCache.enablePrefetch=function(){Backbone.fetchCache.prefetch=!0,Backbone.fetchCache.getPrefetchRequests()},Backbone.fetchCache.disablePrefetch=function(){Backbone.fetchCache.prefetch=!1},Backbone.fetchCache.priorityFn=function(a,b){return a&&a.expires&&b&&b.expires?a.expires-b.expires:a},Backbone.fetchCache._prioritize=function(a){a=a||Backbone.fetchCache._cache;var b=_.values(a).sort(this.priorityFn),c=_.indexOf(_.values(a),b[0]);return _.keys(a)[c]},Backbone.fetchCache.prefetchStoreProcessor=function(a){return a},Backbone.fetchCache.prefetchRetrieveProcessor=function(a){return a},Backbone.fetchCache._deleteCacheWithPriority=function(a){a=a||Backbone.fetchCache._cache;var b=this._prioritize(a);a[b]=null,delete a[b],Backbone.fetchCache.setLocalStorage(a)},Backbone.fetchCache.getLocalStorageKey=function(){return"backboneCache"},Backbone.fetchCache.getPrefetchStorageKey=function(){return"backboneCachePrefetch"},"undefined"==typeof Backbone.fetchCache.localStorage&&(Backbone.fetchCache.localStorage=!0);var v=function(){function b(){c.length>0?a.active<2?(c.splice(0,1)[0](),b()):setTimeout(b,2e3):Backbone.trigger("prefetchLoaded")}var c=[];return function(a){c.push(a),b()}}();return Backbone.Model.prototype.fetch=function(b){function d(){return b.prefill&&(!b.prefillExpires||j)}function e(){var a=(Backbone.fetchCache.selfParameter?[]:[h.value]).concat(m);b.parse&&(k=m.parse(k,b)),m.set(k,b),_.isFunction(b.prefillSuccess)&&b.prefillSuccess(m,k,b),m.trigger("cachesync",m,k,b),m.trigger("sync",m,k,b),d()?l.notify.apply(m,a):(_.isFunction(b.success)&&b.success(m,k,b),l.resolve.apply(m,a))}if(!Backbone.fetchCache.enabled)return s.modelFetch.apply(this,arguments);b=_.defaults(b||{},{parse:!0});var g=Backbone.fetchCache.getCacheKey(this,b),h=f(g),i=!1,j=!1,k=!1,l=new a.Deferred,m=this;if(l.success=l.done,l.error=l.fail,h&&(i=h.expires,i=i&&h.expires<=(new Date).getTime(),j=h.prefillExpires,j=j&&h.prefillExpires<=(new Date).getTime(),k=h.value),!i&&(b.cache||b.prefill)&&k&&(null==b.async&&(b.async=!0),b.beforeSend&&b.beforeSend.apply(this,[l,b]),b.async?q(e):e(),!d()))return l;Backbone.fetchCache.useEtags&&(b.ifModified=!0),m.on("resetData",function(a,b){_.extend(a,c(m,b,a.value))});var n=s.modelFetch.apply(this,arguments),o=[];return Backbone.fetchCache.selfParameter&&o.push(this),n.done(function(a){l.resolve.apply(m,o.concat([a,m]))}).done(_.bind(Backbone.fetchCache.setCache,null,this,b)).fail(_.bind.apply(_,[l.reject].concat(o))),l.abort=n.abort,l},Backbone.Model.prototype.sync=function(a,b,c){if("read"===a||!Backbone.fetchCache.enabled)return s.modelSync.apply(this,r(this,arguments));var d,e,f=b.collection,g=[];for(g.push(Backbone.fetchCache.getCacheKey(b,c)),f&&g.push(Backbone.fetchCache.getCacheKey(f)),d=0,e=g.length;e>d;d++)h(g[d]);return s.modelSync.apply(this,r(this,arguments))},Backbone.Collection.prototype.sync=function(){return s.collectionSync.apply(this,r(this,arguments))},Backbone.Collection.prototype.fetch=function(b){function d(){return b.prefill&&(!b.prefillExpires||i)}function e(){var a=(Backbone.fetchCache.selfParameter?[]:[m.value]).concat(g);g[b.reset?"reset":"set"](j,b),_.isFunction(b.prefillSuccess)&&b.prefillSuccess(g),g.trigger("cachesync",g,j,b),g.trigger("sync",g,j,b),d()?k.notify.apply(g,a):(_.isFunction(b.success)&&b.success(g,j,b),k.resolve.apply(g,a))}if(!Backbone.fetchCache.enabled)return s.collectionFetch.apply(this,arguments);b=_.defaults(b||{},{parse:!0});var g=this,h=!1,i=!1,j=!1,k=new a.Deferred,l=Backbone.fetchCache.getCacheKey(g,b),m=f(l);if(k.success=k.done,k.error=k.fail,m&&(h=m.expires,h=h&&m.expires<=(new Date).getTime(),i=m.prefillExpires,i=i&&m.prefillExpires<=(new Date).getTime(),j=m.value),!h&&(b.cache||b.prefill)&&j&&(null==b.async&&(b.async=!0),b.beforeSend&&b.beforeSend.apply(this,[k,b]),b.async?q(e):e(),!d()))return k;Backbone.fetchCache.useEtags&&(b.ifModified=!0),g.on("resetData",function(a,b){_.extend(a,c(g,b,a.value))});var n=s.collectionFetch.apply(g,arguments),o=[];return Backbone.fetchCache.selfParameter&&o.push(this),n.done(function(a,b,c){c&&304===c.status||k.resolve.apply(g,o.concat([a,g]))}).done(_.bind(Backbone.fetchCache.setCache,null,g,b)).fail(_.bind.apply(_,[k.reject].concat(o))),k.abort=n.abort,k},n(),p(),Backbone.fetchCache._superMethods=s,Backbone.fetchCache.setCache=d,Backbone.fetchCache.getCache=f,Backbone.fetchCache.getCacheKey=b,Backbone.fetchCache.getLastSync=g,Backbone.fetchCache.clearItem=h,Backbone.fetchCache.setLocalStorage=i,Backbone.fetchCache.getLocalStorage=n,Backbone.fetchCache.setPrefetchRequests=m,Backbone.fetchCache.getPrefetchRequests=p,Backbone});